<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->

<mapper namespace="com.spring.app.rdg.mapper.RdgMapper">
	
	
	<!-- 글쓰기 버튼 클릭시 insert -->
	<insert id="add" parameterType="BoardDTO">
		<if test="boardFileOriginName == null">
			INSERT INTO board(boardNo, fk_categoryNo, boardName, boardContent, createdAtBoard, updatedAtBoard, readCount, fk_id, boardDeleted)
			VALUES(BOARD_SEQ.nextval, #{fk_categoryNo, jdbcType=NUMERIC}, #{boardName}, #{boardContent}, default, default, default, #{fk_id}, default)
		</if>
		
		<if test="boardFileOriginName != null">
			INSERT INTO board(boardNo, fk_categoryNo, boardName, boardContent, createdAtBoard, updatedAtBoard, readCount, fk_id, boardDeleted, boardFileName, boardFileOriginName)
			VALUES(BOARD_SEQ.nextval, #{fk_categoryNo, jdbcType=NUMERIC}, #{boardName}, #{boardContent}, default, default, default, #{fk_id}, default, #{boardFileName}, #{boardFileOriginName})
		</if>
		</insert>
	
	
	<!-- 카테고리별 페이징 처리된 검색된 리스트 목록 가져오기(페이지당 3개의 목록 고정) -->
	<select id="getBoardList" parameterType="HashMap" resultType="BoardDTO">
		SELECT boardNo, boardName, boardContent, createdAtBoard, updatedAtBoard, readCount, fk_id, boardFileName, boardFileOriginName, U.name
		FROM BOARD B JOIN Users U
		ON B.fk_id = U.id
		WHERE boardDeleted = 0 AND B.fk_categoryNo = TO_NUMBER(#{fk_categoryNo})
		<choose>
			<when test='searchType == "boardName" and searchWord != ""'>
				AND lower(boardName) like '%'||lower(#{searchWord})||'%'
			</when>
			<when test='searchType == "boardContent" and searchWord != ""'>
				AND lower(boardContent) like '%'||lower(#{searchWord})||'%'
			</when>
			<when test='searchType == "boardName_boardContent" and searchWord != ""'>
				AND ( lower(boardName) like '%'||lower(#{searchWord})||'%' or lower(boardContent) like '%'||lower(#{searchWord})||'%' )
			</when>
			<when test='searchType == "name" and searchWord != ""'>
				AND lower(name) like '%'||lower(#{searchWord})||'%'
			</when>
		</choose>
		ORDER BY boardNo DESC
		OFFSET ((TO_NUMBER(#{currentShowPageNo}) - 1) * 3) ROWS
		FETCH NEXT 3 ROW ONLY
	</select>
	
	
	<!-- 해당 카테고리 검색된 게시글의 총 개수 -->
	<select id="getBoardCount" parameterType="HashMap" resultType="int">
		SELECT COUNT(*) AS totalCount
		FROM board B JOIN Users U
		ON B.fk_id = U.id
		WHERE boardDeleted = 0 AND B.fk_categoryNo = TO_NUMBER(#{fk_categoryNo})
		<choose>
			<when test='searchType == "boardName" and searchWord != ""'>
				AND lower(boardName) like '%'||lower(#{searchWord})||'%'
			</when>
			<when test='searchType == "boardContent" and searchWord != ""'>
				AND lower(boardContent) like '%'||lower(#{searchWord})||'%'
			</when>
			<when test='searchType == "boardName_boardContent" and searchWord != ""'>
				AND ( lower(boardName) like '%'||lower(#{searchWord})||'%' or lower(boardContent) like '%'||lower(#{searchWord})||'%' )
			</when>
			<when test='searchType == "name" and searchWord != ""'>
				AND lower(name) like '%'||lower(#{searchWord})||'%'
			</when>
		</choose>
	</select>
	
	
	<!-- 해당 카테고리 제목 + 내용 가져오기 -->
	<select id="getBoardContents" parameterType="String" resultType="BoardDTO">
		SELECT boardName, boardContent
		FROM board
		WHERE boardDeleted = 0 AND fk_categoryNo = TO_NUMBER(#{fk_categoryNo})
	</select>
	
	
	<!-- 자동 검색어 완성시킬 제목 or 이름 가져오기 -->
	<select id="getSearchWordList" parameterType="HashMap" resultType="String">
		<choose>
			<when test='searchType == "boardName"'>
				SELECT boardName
				FROM board
				WHERE boardDeleted = 0 AND fk_categoryNo = TO_NUMBER(#{fk_categoryNo})
				AND lower(boardName) LIKE '%' || lower(#{searchWord}) || '%'
				ORDER BY createdAtBoard
			</when>
			<otherwise>
				SELECT DISTINCT name
				FROM board B JOIN users U
				ON B.fk_id = U.id
				WHERE boardDeleted = 0 AND B.fk_categoryNo = TO_NUMBER(#{fk_categoryNo})
				AND lower(name) LIKE '%' || lower(#{searchWord}) || '%'
				ORDER BY name
			</otherwise>
		</choose>
	</select>
	
	
	<!-- 글 1개 가져오기 -->
	<select id="selectView" parameterType="HashMap" resultType="BoardDTO">
		select *
		from board B join users U
		ON B.fk_id = U.id
		where boardno = to_number(#{boardNo})
	</select>
	
	
</mapper>




